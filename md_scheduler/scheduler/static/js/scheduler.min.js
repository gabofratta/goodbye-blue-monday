function resetCustomSelector(t){t.find(".multi_options").hide(),t.find('.multi_options input[type="checkbox"]').prop("checked",!1),t.find("option").text("Select...")}function setCustomSelections(t,e){t.find('.multi_options input[type="checkbox"]').each(function(t){var i=-1!==jQuery.inArray($(this).val(),e);$(this).prop("checked",i)}),updateCustomSelectorText(t,e.length)}function updateCustomSelectorText(t,e){var i=t.find("option");0==e?i.text("Select..."):i.text(e+" selected")}function filterCustomSelectHandler(t){var e=[],i=t.parent().parent(),n=i.parent();i.find('input[type="checkbox"]').each(function(t){$(this).is(":checked")&&e.push($(this).val())}),updateCustomSelectorText(n,e.length),n.next(".f_act_slot_selector").val(e),setCorralValues(n.parent().next(),e)}function createCustomOptions(t,e){var i=t.find(".multi_options");i.empty();for(var n=0;n<e.length;n++){$('<label class="check_label"><input type="checkbox" value="'+e[n]+'" /><span class="checkmark"></span>'+e[n]+"</label>").appendTo(i).find('input[type="checkbox"]').prop("checked",!0)}updateCustomSelectorText(t,e.length),$('.f_activity .multi_options input[type="checkbox"]').on("click",function(){filterCustomSelectHandler($(this))})}function setCorralValues(t,e){t.find(".top_div .start_tag").each(function(){-1===e.indexOf($(this).text())?$(this).parents(".tag").fadeOut(300):$(this).parents(".tag").fadeIn(300)})}function makeStateFlag(){var t=!1;return{in_progress:function(){return t},start:function(){t=!0},stop:function(){t=!1}}}function makeSlotConverter(){var t={},e={};return $(".act_slot_selector").first().children().each(function(i){var n=$(this).val();t[i+1]=n,e[n]=i+1}),{id_to_text:function(e){return t[e]},text_to_id:function(t){return e[t]},get_end_slot:function(i,n){return t[e[i]+n-1]}}}function getVoidItineraries(){return{size:0,itineraries:[],activity_names:[],activity_slots:{},activity_lengths:{},activity_slot_itineraries:{}}}function buildItineraries(t){var e=t.size,i=0,n=t.itineraries,o=e,a=deepCopy(n),r=t.activity_names,s=t.activity_slots,c=t.activity_lengths,l=t.activity_slot_itineraries;return{get_count:function(){return o},get_unfiltered_count:function(){return e},get_index:function(){return i},next:function(){return i=(i+1)%o},prev:function(){return 0==i?i=o-1:i--,i},get_activities:function(){return deepCopy(a[i])},reset_filter:function(){a=deepCopy(n),o=e,i=0},filter_out:function(t){t.sort(function(t,e){return t-e});for(var e=t.length-1;e>=0;e--)a.splice(t[e],1);o=a.length},is_filtered:function(){return o!==e},get_activity_count:function(){return r.length},get_activity_length:function(t){return c[t]},get_activity_slots:function(t){return s[t].slice()},get_activity_names:function(){return r.slice()},get_itineraries_for:function(t,e){return l[t][e].slice()}}}function deepCopy(t){return JSON.parse(JSON.stringify(t))}$(document).ready(function(){$(".select_box").on("click",function(){var t=$(this).parent().find(".multi_options");if(t.is(":visible"))$(".multi_options").hide();else{$(".multi_options").hide();var e=$(window).height()-$(this)[0].getBoundingClientRect().bottom,i=t.css("height");(i=i.substring(0,i.length-2))>e?t.css("top","-"+i+"px"):t.css("top",""),setTimeout(function(){t.scrollTop(0)},0),t.show()}}),$(document).bind("click",function(t){$(t.target).parents().hasClass("multi_select")||$(".multi_options").hide()}),$('.activity .multi_options input[type="checkbox"]').on("click",function(){var t=[],e=$(this).parent().parent(),i=e.parent();e.find('input[type="checkbox"]').each(function(e){$(this).is(":checked")&&t.push($(this).val())}),i.parent().next().find(".selected_slots").val(t.join("\n")),updateCustomSelectorText(i,t.length),i.next(".act_slot_selector").val(t)})}),$(document).ready(function(){var t=new Hammer(document.getElementById("schedule"),{}),e=makeStateFlag(),i=makeStateFlag(),n=makeStateFlag(),o=buildItineraries(getVoidItineraries()),a=makeSlotConverter(),r=12,s=4,c=25,l=[["RED","WHITE"],["BLUE","WHITE"],["PURPLE","WHITE"],["GREEN","WHITE"],["GRAY","WHITE"],["#aa6e28","WHITE"],["NAVY","WHITE"],["MAROON","WHITE"],["OLIVE","WHITE"],["TEAL","WHITE"],["BLACK","WHITE"],["YELLOW","BLACK"],["LIME","BLACK"],["AQUA","BLACK"],["FUCHSIA","BLACK"],["ORANGE","BLACK"],["PINK","BLACK"],["SILVER","BLACK"]];function u(t,e){if($(".alert-success").fadeOut(),o=buildItineraries(getVoidItineraries()),$(".program_index").html("&nbsp;"),$("#schedule").find(".activity_display").text("").hide(),0===e.size)var n=y();else n=e;if(n.size>0){$(".alert-danger").fadeOut();var r=setTimeout(function(){$(".loading").removeClass("hidden")},300);t||history.pushState({data:n},"",""),$.ajax({url:"/ajax/generate_programs",type:"POST",data:JSON.stringify(n),dataType:"json",success:function(t,e){return t.success?t.size<=0?(d(r),f(".alert-danger","No schedules meet your requirements."),void i.stop()):(o=buildItineraries(t),function(){var t=$("#filter_pane"),e=t.find(".f_activity"),i=o.get_activity_names(),n=i.length-e.length;n>0&&function(t){var e=$(".f_activity").last(),i=e.clone(!0),n=$();i.find(".f_act_name").text(""),i.find("select.f_act_slot_selector").val([]),resetCustomSelector(i.find(".multi_select")),i.find(".top_div").empty(),n=n.add(i);for(var o=1;o<t;o++){var a=i.clone(!0);n=n.add(a)}n.each(function(){$(this).insertAfter(e.next("hr")),$('<hr class="w-90-pc mtb-2_em">').insertAfter(this)})}(n);for(var r=e.length-1;r>=i.length;r--)e.eq(r).next("hr").remove(),e.eq(r).remove();(e=t.find(".f_activity")).each(function(t){var e=i[t],n=o.get_activity_length(e),r=o.get_activity_slots(e).map(a.id_to_text);$(this).find(".f_act_name").text(e),createCustomOptions($(this).find(".multi_select"),r),function(t,e){t.empty();for(var i=0;i<e.length;i++){var n=$('<option value="'+e[i]+'">'+e[i]+"</option>");n.appendTo(t).prop("selected",!0)}}($(this).find(".f_act_slot_selector"),r);var s=$(this).find(".top_div");s.empty();for(var c=0;c<r.length;c++){var l=$('<div class="tag"><span class="start_tag">'+r[c]+"</span><span>&nbsp;-&nbsp;"+a.get_end_slot(r[c],n)+'</span><a href="#" class="close remove_tag">&times;</a></div>');s.append(l)}$(".remove_tag").click(function(){return function(t){$(".multi_options").hide();var e=t.parents(".f_activity"),i=t.find(".start_tag").text();t.fadeOut(300),e.find('.multi_options input[type="checkbox"][value="'+i+'"]').prop("checked",!1),e.find('.f_act_slot_selector option[value="'+i+'"]').prop("selected",!1);var n=e.find(".f_act_slot_selector").val().length;updateCustomSelectorText(e.find(".multi_select"),n)}($(this).parents(".tag")),!1})})}(),v(!1),d(r),f(".alert-success","Your schedule options are ready."),void i.stop()):(d(r),f(".alert-danger","Fatal error: "+t.error),void i.stop())},error:function(t,e,n){d(r),f(".alert-danger","Unexpected error. Reload the page and try again."),i.stop(),console.log(n)}})}else i.stop()}function d(t){clearTimeout(t),$(".loading").addClass("hidden")}function f(t,e){var i=$(t);".alert-danger"==t?$(".alert-success").fadeOut():$(".alert-danger").fadeOut(),i.fadeOut(100,function(){i.find("strong").text(e),i.fadeIn()})}function p(t){var e=$(".activity"),i=e.last(),n=i.clone(!0),o=$();n.find("input[type='text']").val(""),n.find(".selected_slots").val(""),resetCustomSelector(n.find(".multi_select")),n.find(".act_slot_selector").val([]),n.find(".remove_activity").removeClass("hidden"),o=o.add(n);for(var a=1;a<t;a++){var r=n.clone(!0);o=o.add(r)}o.each(function(){$(this).insertAfter(i).hide().slideDown(500,function(){$('<div class="act_spacer spacer20"></div>').insertBefore(this).hide().slideDown(500)})}),e.first().find(".remove_activity").removeClass("hidden")}function _(t,e){var i=t.prev(".act_spacer"),n=$(".activity"),o=0;0===i.length&&(i=t.next(".act_spacer"),o=1),e&&n.eq(o).find(".remove_activity").addClass("hidden"),t.slideUp(500,function(){$(this).remove(),i.slideUp(500,function(){$(this).remove()})})}function v(t){var e=$("#schedule"),i=e.find(".activity_display");if(i.text("").css({"background-color":"",color:""}),t||i.height("auto"),o.get_count()>0){for(var n=o.get_activities(),a=0,u=0;u<n.length;u++)for(var d=n[u].code+" - "+h(n[u].name,c)+" ("+n[u].category.substring(0,2)+")",f=0;f<n[u].slots.length;f++){var p=Math.floor((n[u].slots[f]-1)/r)+1,_=Math.floor((n[u].slots[f]-1)%r/s)+1,v=(n[u].slots[f]-1)%s+1,m=e.find(".row_"+p).find(".month_"+_).find(".cell_"+v);if(m.text(d),u<l.length&&m.css("background-color",l[u][0]).css("color",l[u][1]),!t){var g=e.find(".row_"+p+":visible").find(".month_"+_).find(".cell_"+v).height();a=Math.max(g,a)}}t||i.height(a+1+"px").show()}else i.hide();if(o.get_unfiltered_count()>0){var y=o.is_filtered()?"<strong>Filtered: </strong>":"",x=0==o.get_count()?0:o.get_index()+1;$(".program_index").html(y+x+" of "+o.get_count())}else $(".program_index").html("&nbsp;")}function h(t,e){return t.length<=e?t:t.substring(0,e-3).trim()+"..."}function m(t){var e=t.size;if(null==e||e<1)throw"Invalid array size";var i=e-$(".activity").length;i>0&&p(i);for(var n=$(".activity"),o=0;o<e;o++){var a=n.eq(o),r=t.activities[o],s=r.slots;a.find(".act_code").val(r.code),a.find(".act_name").val(r.name),a.find(".act_category").val(r.category),a.find(".act_slot_selector").val(s),setCustomSelections(a.find(".multi_select"),s),a.find(".act_length").val(r.length),a.find(".selected_slots").val(s.join("\n"))}var c=e<=1;for(o=n.length-1;o>=Math.max(e,1);o--)_(n.eq(o),c),c=!1}function g(){var t=$(".activity"),e=t.first(),i=!0;e.find("input[type='text']").val(""),e.find("select").val(""),e.find(".act_slot_selector").val([]),setCustomSelections(e.find(".multi_select"),[]),e.find(".selected_slots").val("");for(var n=1;n<t.length;n++)_(t.eq(n),i),i=!1}function y(){var t={activities:[]},e=!0,i={};return $(".activity").each(function(n){var o={};return o.code=$(this).find(".act_code").val().trim(),o.name=$(this).find(".act_name").val().trim(),o.category=$(this).find(".act_category").val(),o.slots=$(this).find(".act_slot_selector").val(),o.length=$(this).find(".act_length").val(),void 0!==i[o.name]?(f(".alert-danger","Activity names must be unique."),e=!1,!1):(i[o.name]=!0,""==o.code||""==o.name||null==o.category||0==o.slots.length||null==o.length?(f(".alert-danger","Activity number "+(n+1)+" is incomplete."),e=!1,!1):void t.activities.push(o))}),e?(t.size=t.activities.length,t):{size:0,activities:[]}}function x(){var t=$("#filter_pane");$("#filter_contents").fadeOut(100),t.css("width","0"),$("body").css({overflow:"auto","margin-right":"0"}),$("nav").css({left:"0"}),t.scrollTop(0)}$("#filter_contents").hide(),history.replaceState({data:{size:0,activities:[]}},"",""),window.addEventListener("popstate",function(t){$(".multi_options").hide();var e=t.state;return $(".alert").fadeOut(),null!==e&&(e.data.size>0?(m(e.data),u(!0,e.data)):(g(),o=buildItineraries(getVoidItineraries()),v(!1))),!1}),$(".close_alert").click(function(){return $(".multi_options").hide(),$(this).closest(".alert").fadeOut(),!1}),t.on("swiperight",function(){return $(".multi_options").hide(),0!=o.get_count()&&(o.prev(),v(!0),!1)}),t.on("swipeleft",function(){return $(".multi_options").hide(),0!=o.get_count()&&(o.next(),v(!0),!1)}),$(".prev_program").click(function(){return $(".multi_options").hide(),0==o.get_count()?(f(".alert-danger","No schedules available."),!1):(o.prev(),v(!0),!1)}),$(".next_program").click(function(){return $(".multi_options").hide(),0==o.get_count()?(f(".alert-danger","No schedules available."),!1):(o.next(),v(!0),!1)}),$(".copy_program").click(function(){if($(".multi_options").hide(),0==o.get_count())return f(".alert-danger","No schedules available."),!1;for(var t="",e=o.get_activities(),i=0;i<e.length;i++){for(var n=e[i].code+" - "+e[i].name+" - "+e[i].category+": ",r=0;r<e[i].slots.length;r++){n+=a.id_to_text(e[i].slots[r])+", "}t+=n.substring(0,n.length-2)+"\n"}return function(t){{if(window.clipboardData&&window.clipboardData.setData)return clipboardData.setData("Text",t);if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var e=document.createElement("textarea");e.textContent=t,e.style.position="fixed",document.body.appendChild(e),e.select();try{document.execCommand("copy")}catch(t){return console.warn("Copy to clipboard failed.",t),!1}finally{document.body.removeChild(e)}}}}(t),f(".alert-success","Schedule copied to clipboard."),!1}),$("#export_acts").click(function(){$(".multi_options").hide();var t=y();return t.size>0&&(!function(t,e){{if(window.navigator.msSaveBlob){var i=new Blob([e],{type:"text/plain;charset=utf-8;"});return window.navigator.msSaveBlob(i,t)}var n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),n.setAttribute("download",t),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}}("ms4planner_activities.txt",JSON.stringify(t)),f(".alert-success","Activities exported successfully.")),!1}),$("#import_acts").click(function(){return $(".multi_options").hide(),$("#file_input").click(),!1}),$("#file_input").change(function(){if(e.in_progress())return!1;if(e.start(),!(window.File&&window.FileReader&&window.FileList&&window.Blob))return f(".alert-danger","Your browser does not support this feature."),$(this).val(""),e.stop(),!1;var t=$(this)[0].files[0];if(null==t)return $(this).val(""),e.stop(),!1;if("text/plain"!=t.type)return f(".alert-danger","Invalid file type. Expecting a text file."),$(this).val(""),e.stop(),!1;if(t.size=t.size>5e3)return f(".alert-danger","Invalid file size."),$(this).val(""),e.stop(),!1;var i,n=new FileReader;return n.onload=(i=n,function(){var t=setTimeout(function(){$(".loading").removeClass("hidden")},500);try{m(JSON.parse(i.result)),f(".alert-success","Activities imported successfully.")}catch(t){g(),f(".alert-danger","There was something wrong with the imported file.")}finally{d(t),e.stop()}}),n.readAsText(t),$(this).val(""),!1}),$(".act_slot_selector").change(function(){var t=$(this).val(),e=$(this).parent();e.next().find(".selected_slots").val(t.join("\n")),setCustomSelections(e.find(".multi_select"),t)}),$("#add_activity").click(function(){return $(".multi_options").hide(),p(1),!1}),$(".remove_activity").click(function(){$(".multi_options").hide();var t=2==$(".activity").length;return _($(this).closest(".activity"),t),!1}),$(".filter_program").click(function(){if($(".multi_options").hide(),0==o.get_unfiltered_count())return f(".alert-danger","No schedules available."),!1;$(".alert").fadeOut(),$("#filter_pane").css("width","100%"),$("#filter_contents").fadeIn(1250);var t=window.innerWidth-$(document).width();return $("body").css({overflow:"hidden","margin-right":t+"px"}),$("nav").css({left:-t+"px"}),!1}),$("#close_filter").click(function(){return $(".multi_options").hide(),x(),!1}),$(".f_act_slot_selector").change(function(){var t=$(this).val(),e=$(this).parent();setCustomSelections(e.find(".multi_select"),t),setCorralValues(e.next(),t)}),$(".f_add_all").click(function(){$(".multi_options").hide(),$(this).parent().prev().find(".tag").fadeIn(300);var t=$(this).parents(".f_activity");t.find(".f_act_slot_selector option").prop("selected",!0);var e=t.find(".f_act_slot_selector").val();return setCustomSelections(t.find(".multi_select"),e),!1}),$(".f_remove_all").click(function(){$(".multi_options").hide(),$(this).parent().prev().find(".tag").fadeOut(300);var t=$(this).parents(".f_activity");return resetCustomSelector(t.find(".multi_select")),t.find(".f_act_slot_selector").val([]),!1}),$("#apply_filter").click(function(){return $(".multi_options").hide(),!n.in_progress()&&(n.start(),$(".loading").removeClass("hidden"),setTimeout(function(){o.reset_filter();var t=[],e={};$(".f_activity").each(function(i){var n=$(this).find(".f_act_slot_selector option:not(:selected)"),r=$(this).find(".f_act_name").text();n.each(function(i){var n=a.text_to_id($(this).val()),s=o.get_itineraries_for(r,n);for(i=0;i<s.length;i++)void 0===e[s[i]]&&(e[s[i]]=!0,t.push(s[i]))})}),o.filter_out(t),v(!1),$(".loading").addClass("hidden"),x(),f(".alert-success","Schedules filtered successfully."),n.stop()},50),!1)}),$("#generate").click(function(){return $(".multi_options").hide(),!i.in_progress()&&(i.start(),u(!1,{size:0}),!1)});var b=function(t){var e=null;if(document.cookie&&""!==document.cookie)for(var i=document.cookie.split(";"),n=0;n<i.length;n++){var o=jQuery.trim(i[n]);if(o.substring(0,t.length+1)===t+"="){e=decodeURIComponent(o.substring(t.length+1));break}}return e}("csrftoken");$.ajaxSetup({crossDomain:!1,beforeSend:function(t,e){var i;i=e.type,/^(GET|HEAD|OPTIONS|TRACE)$/.test(i)||t.setRequestHeader("X-CSRFToken",b)}})});